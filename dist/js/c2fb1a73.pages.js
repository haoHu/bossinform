!function(){IX.ns("Hualala");var a=new IX.IListManager,b=['<div id="ix_wrapper">',"</div>"].join("");a.register("tpl_site_layout",b);var c=['<div id="site_toptip_{{id}}" class="site-toptip alert alert-{{type}} fade in ">',"<p>{{msg}}</p>","</div>"].join("");a.register("tpl_site_toptip",c);var d=['<header class="bar bar-nav bi-bar {{clz}}">',"{{#with iconBtn}}","{{#each items}}","{{> iconBtn}}","{{/each}}","{{/with}}","{{#with commonBtn}}","{{#each items}}","{{> commonBtn}}","{{/each}}","{{/with}}",'<h1 class="title">{{{title}}}</h1>',"</header>"].join("");a.register("tpl_app_bar",d);var e=['<button class="btn {{clz}}">',"{{#if isIconBtn}}",'<span class="icon {{iconClz}}"></span>',"{{/if}}","{{label}}","</button>"].join("");a.register("tpl_common_btn",e);var f=['<a class="icon {{clz}}" href="{{href}}" data-label="{{label}}">',"</a>"].join("");a.register("tpl_icon_btn",f);var g=["{{#with appBar}}","{{> appBar}}","{{/with}}",'<div class="content">','<div class="segmented-control bi-login-tab">',"{{#each segHeads}}",'<a class="control-item {{active}} {{clz}}" data-href="segmented" href="#{{id}}">',"{{{label}}}","</a>","{{/each}}","</div>","{{#each segContents}}",'<div class="control-content {{active}} {{clz}}" id="{{id}}">','<div class="card">','<form class="input-group">',"{{#each items}}",'<div class="{{clz}}">',"<label>{{label}}</label>",'<input type="{{type}}" placeholder="{{placeholder}}" name="{{name}}" data-key="{{key}}" id="{{id}}" />',"</div>","{{/each}}",'<button class="btn btn-positive btn-block subBtn" >','<span class="icon icon-check"></span>',"</button>","</form>","</div>",'<div class="card info">',"{{{desc}}}","</div>","</div>","{{/each}}","</div>"].join("");a.register("tpl_site_login",g);var h=['<div class="bi-authcode">','<img alt="动态验证码" class="auth-img" src="" />',"</div>"].join("");a.register("tpl_auth_code",h);var i=['<button class="btn btn-warning bi-dynamicpwd" data-loading-text="{{loadingText}}">',"{{{label}}}","</button>"].join("");a.register("tpl_dynamic_pwd",i);var j=['<ul class="table-view brand-list {{clz}}">',"{{#each items}}",'<li class="table-view-cell brand-item {{clz}}">','<a class="navigate-right" href="{{href}}" data-transition="slide-in" data-href="push" data-item-id="{{groupID}}">','<div class="row">','<div class="col-xs-3">','<img src="{{logo}}" alt="{{groupName}}" class="brand-logo" />',"</div>",'<div class="col-xs-3">','<span class="price">{{personTotal}}</span>','<span class="unit">{{personUnit}}</span>',"</div>",'<div class="col-xs-3">','<span class="price">{{orderCountTotal}}</span>','<span class="unit">{{orderUnit}}</span>',"</div>",'<div class="col-xs-3">','<span class="price">{{orderAomoutTotal}}</span>','<span class="unit">{{cashUnit}}</span>',"</div>","</div>","</a>","</li>","{{/each}}","</ul>"].join("");a.register("tpl_brand_list",j);var k=['<div class="segmented-control {{clz}}">',"{{#each segments}}",'<a class="control-item {{active}} {{clz}}" href="{{href}}" data-href="segmented">',"{{{label}}}","</a>","{{/each}}","</div>","{{#each segments}}",'<div id="{{id}}" class="control-content {{active}}">',"</div>","{{/each}}"].join("");a.register("tpl_segment_bar",k);var l=["{{#with appBar}}","{{> appBar}}","{{/with}}",'<div class="content">',"</div>"].join("");a.register("tpl_page_layout",l);var m=['<div class="bi-toolbar">','<div class="bi-filter">',"{{#each items}}",'<div class="filter-item" data-toggle="dropdown" id="dropdown_{{key}}" data-key="{{key}}"',"{{#if isShopFilter }}",' data-shopid="{{value}}" data-cityid="{{cityID}}"',"{{else}}",' data-value="{{value}}" ',"{{/if}}",">",'<div class="item-label">','<span class="label {{clz}}">',"{{{label}}}","</span>",'<span class="icon icon-down "></span>',"</div>","</div>","{{/each}}","</div>","</div>"].join("");a.register("tpl_filter_toolbar",m);var n=['<div class="brand-chart {{clz}}">','<div class="chart-list clearfix">',"</div>","</div>"].join("");a.register("tpl_brand_chart",n);var o=['<div class="bi-table">','<div class="table-header">',"{{#each header}}",'<div class="table-cell {{clz}}">',"{{#if isHistory}}","{{#with iconBtn}}","{{#each items}}","{{> iconBtn}}","{{/each}}","{{/with}}","{{/if}}",'<span class="date">',"{{{dateStr}}}","</span>","</div>","{{/each}}","</div>",'<div class="table-body">',"{{#each rows}}",'<a class="table-row {{clz}}"  data-charttype="{{chartType}}" href="{{href}}" data-transition="slide-in" data-href="push">','{{#chkRowType type type="common"}}',"{{#each cols}}",'<div class="table-cell {{clz}} {{hidden}}">',"{{> commonCol}}","</div>","{{/each}}","{{/chkRowType}}",'{{#chkRowType type type="chart"}}',"{{#each cols}}",'<div class="table-cell {{clz}} {{hidden}}">',"{{> chartCol}}","</div>","{{/each}}","{{/chkRowType}}",'{{#chkRowType type type="list"}}',"{{#each cols}}",'<div class="table-cell {{clz}} {{hidden}}">',"{{> listCol}}","</div>","{{/each}}","{{/chkRowType}}","</a>","{{/each}}","</div>","</div>"].join("");a.register("tpl_statistic_table",o);var p=['<div class="table-row ">','<span class="table-cell label">{{label}}</span>','<span class="table-cell num">{{{value}}}</span>','<span class="table-cell unit">{{{unit}}}</span>',"</div>","{{#if hasUncheckout }}",'<div class="table-row uncheckout {{clz}}">','<span class="table-cell label">{{unCheckoutLabel}}</span>','<span class="table-cell num">{{{waitCheckoutOrderAmountTotal}}}</span>','<span class="table-cell unit">{{{unit}}}</span>',"</div>","{{/if}}"].join("");a.register("tpl_tblcell_common",p);var q=['<div class="">','<h5 class="">{{label}}</h5>','<div class="chart-canvas">',"</div>","{{#each items}}",'<div class="table-row chart-legend {{clz}}">','<span class="table-cell label">','<span class="legend-icon {{iconClz}}"></span>',"<span>{{{label}}}</span>","</span>",'<span class="table-cell num">{{{value}}}</span>','<span class="table-cell unit">{{{unit}}}</span>',"</div>","{{/each}}","</div>"].join("");a.register("tpl_tblcell_chart",q);var r=['<div class="">','<h5 class="">{{label}}</h5>',"<ul>","{{#each items}}","<li>",'<span class="label">',"{{{payName}}}","</span>",'<span class="percent">',"{{{payPercent}}}","</span>",'<span class="num">',"{{{payAmount}}}","</span>",'<span class="unit">',"{{{../cashUnit}}}","</span>","</li>","{{/each}}","</ul>","</div>"].join("");a.register("tpl_tblcell_list",r);var s=["{{#if isEmpty }}",'<div class="text-center text-muted">无数据</div>',"{{else}}",'<ul class="drop-list {{clz}}">',"{{#each items}}",'<li class="list-item {{active}}" data-value="{{value}}">','<span class="label">','<img class="brand-logo" src="{{logo}}"/>',"{{label}}","</span>","</li>","{{/each}}","</ul>","{{/if}}"].join("");a.register("tpl_group_droplist",s);var t=["{{#if isEmpty }}",'<div class="text-center text-muted">无数据</div>',"{{else}}",'<div class="drop-list {{clz}}">','<div class="menu-city pull-left">','<ul class="">','<li class="city-item" data-cityid="" >','<span class="label">全部店铺</span>','<span class="num">{{total}}</span>',"</li>","{{#each cities}}",'<li class="city-item" data-cityid="{{cityID}}">','<span class="label">{{cityName}}</span>','<span class="num">({{cityCount}})</span>',"</li>","{{/each}}","</ul>","</div>",'<div class="menu-shop">',"{{#each cities}}",'<ul class="" data-cityID="{{cityID}}">','<li class="shop-item" data-cityid="{{cityID}}" data-shopID="">','<span class="label">{{cityName}}全部店铺</span>',"</li>","{{#each shops}}",'<li class="shop-item" data-cityid="{{cityID}}" data-shopid="{{shopID}}">','<span class="label">{{shopName}}</span>',"</li>","{{/each}}","</ul>","{{/each}}","</div>","</div>","{{/if}}"].join("");a.register("tpl_shop_droplist",t);var u=["{{#if isEmpty }}",'<div class="text-center text-muted">无数据</div>',"{{else}}",'<ul class="drop-list {{clz}}">',"{{#each items}}",'<li class="list-item {{active}}" data-value="{{value}}">','<span class="label">',"{{label}}","</span>","</li>","{{/each}}","</ul>","{{/if}}"].join("");a.register("tpl_cycle_droplist",u);var v=["{{#if isEmpty }}",'<div class="text-center text-muted">无数据</div>',"{{else}}",'<ul class="drop-list {{clz}}">',"{{#each items}}",'<li class="list-item {{active}}" data-value="{{value}}">','<span class="label">',"{{label}}","</span>","</li>","{{/each}}","</ul>","{{/if}}"].join("");a.register("tpl_indicator_droplist",v);var w=function(){return{register:function(b,c){if(a.hasKey(b))throw"This key has registed!!!";a.register(b,c)},get:function(b){if(a.hasKey(b))return a.getByKeys([b])[0];throw"There are no template that is named "+b}}};Hualala.TplLib=new w}(jQuery,window),+function(a){"use strict";function b(b){return this.each(function(){var c=a(this),e=c.data("bs.alert");e||c.data("bs.alert",e=new d(this)),"string"==typeof b&&e[b].call(c)})}var c='[data-dismiss="alert"]',d=function(b){a(b).on("click",c,this.close)};d.VERSION="3.2.0",d.prototype.close=function(b){function c(){f.detach().trigger("closed.bs.alert").remove()}var d=a(this),e=d.attr("data-target");e||(e=d.attr("href"),e=e&&e.replace(/.*(?=#[^\s]*$)/,""));var f=a(e);b&&b.preventDefault(),f.length||(f=d.hasClass("alert")?d:d.parent()),f.trigger(b=a.Event("close.bs.alert")),b.isDefaultPrevented()||(f.removeClass("in"),a.support.transition&&f.hasClass("fade")?f.one("bsTransitionEnd",c).emulateTransitionEnd(150):c())};var e=a.fn.alert;a.fn.alert=b,a.fn.alert.Constructor=d,a.fn.alert.noConflict=function(){return a.fn.alert=e,this},a(document).on("click.bs.alert.data-api",c,d.prototype.close)}(jQuery),function(a){var b=".dropdown-backdrop",c='[data-toggle="dropdown"]',d=function(b,c){this.$trigger=a(b),this.options=a.extend({},a.fn.dropdown.DEFAULT_OPTIONS,c),this.$parentEl=null,this.$backdrop=null,this.$trigger.on("click.ra.dropdown",{ctx:this},this.toggle)};d.prototype={toggle:function(c){var d=a(this),e=c.data.ctx;if(!d.is(".disabled, :disabled")){var f=!1;e.$parentEl=e.getParent(d),e.$parentEl.data("cur.toggle")&&e.$parentEl.data("cur.toggle").attr("id")!=d.attr("id")&&(f=!0),e.$parentEl.data("cur.toggle",d);var g=e.$parentEl.hasClass("open");if(e.clearMenus(c),!g||f){"ontouchstart"in document.documentElement&&a('<div class="dropdown-backdrop"></div>').css({width:a("body").width()+"px",height:document.body.scrollHeight+"px"}).appendTo(e.$parentEl).on("click",{ctx:e},function(a){e.clearMenus(a)});var h={relatedTarget:this};if(c.isDefaultPrevented())return;d.trigger("focus"),e.$parentEl.find(".dropdown-menu").length||a('<div class="dropdown-menu"></div>').appendTo(e.$parentEl),e.$parentEl.trigger(c=a.Event("show.ra.dropdown",h)),e.$parentEl.toggleClass("open").trigger("shown.ra.dropdown",h),"ontouchstart"in document.documentElement&&a(b).css({top:a(".dropdown-menu").offset().top+"px"})}return!1}},clearMenus:function(d){var e=this;d&&3===d.which||(a(b).remove(),a(c).each(function(){var b=e.getParent(a(this)),c={relatedTarget:this};b.hasClass("open")&&(b.trigger(d=a.Event("hide.ra.dropdown",c)),d.isDefaultPrevented()||(b.removeClass("open").trigger("hidden.ra.dropdown",c),b.find(".dropdown-menu").length&&b.find(".dropdown-menu").remove()))}))},getParent:function(b){var c=b.attr("data-target");c||(c=b.attr("href"),c=c&&/#[A-Za-z]/.test(c)&&c.replace(/.*(?=#[^\s]*$)/,"")),c=c?c:this.options.parentSelector;var d=c&&a(c);return d&&d.length?d:b.parent()}},a.fn.dropdown=function(b){return this.each(function(){var c=a(this),e=c.data("ra.dropdown"),f="object"==typeof b&&b;e||c.data("ra.dropdown",e=new d(this,f)),"string"==typeof b&&e[b].call(c)})},a.fn.dropdown.Constructor=d,a.fn.dropdown.DEFAULT_OPTIONS={parentSelector:null},a(document).on("click.ra.dropdown.data-api",function(b){var d=a(c);return d.each(function(c,d){var e=a(d).data("ra.dropdown");e.clearMenus(b)}),!0})}(jQuery),function(a){IX.ns("Hualala.UI");var b=(Hualala.Global,Handlebars),c=Hualala.TplLib,d=function(d){var e=b.compile(c.get("tpl_site_toptip")),f=a(e({id:IX.id(),type:$XP(d,"type","warning"),msg:$XP(d,"msg","")}));f.appendTo("body"),f.bind({"close.bs.alert":function(a){$XF(d,"afterClose")(a)},"close.bs.alert":function(a){$XF(d,"afterClosed")(a)}}),f.addClass("popup"),f.alert();var g=0;setTimeout(function(){1>=g?(setTimeout(arguments.callee,0==g?$XP(d,"interval",1500):500),1==g&&f.removeClass("popup").addClass("bubbleover"),g++):2==g&&f.alert("close")},500)};Hualala.UI.TopTip=d;var e=function(d){var e=b.compile(c.get("tpl_group_droplist")),f=$XP(d,"container"),g=$XP(d,"targetEl"),h=$XF(d,"selectFn");if(f&&g){var i=g.attr("data-value"),j=null,k=Hualala.ShopManager.getGroupSet(),l=function(a){var b=a&&0!=a.length?!1:!0,c=_.map(a,function(a){var b=$XP(a,"groupID"),c=b==i?"active":"",d=$XP(a,"groupLogoImageUrl",""),e=IX.isEmpty(d)?Hualala.Global.getDefaultImage("blank"):Hualala.Common.getSourceImage(d,{width:40,height:40,quality:50});return{value:b,active:c,logo:e,label:$XP(a,"groupLoginName","")}});return{clz:"droplist-group",isEmpty:b,items:c}};j=a(e(l(k))),f.empty().append(j),j.off("click").on("click",".list-item",function(){var b=a(this);j.find(".list-item.active").removeClass("active"),b.addClass("active"),g.attr("data-value",b.attr("data-value")),g.find(".brand-logo").attr("src",b.find(".brand-logo").attr("src")),h(g)})}};Hualala.UI.GroupDropList=e;var f=function(d){var e=b.compile(c.get("tpl_shop_droplist")),f=$XP(d,"container"),g=$XP(d,"targetEl"),h=$XP(d,"groupID"),i=$XF(d,"selectFn");if(f&&g){var j=g.attr("data-cityid")||"",k=g.attr("data-shopid")||"",l=null,m=function(a){var b=a&&0!=a.length?!1:!0,c=0;return _.each(a,function(a){c+=parseInt($XP(a,"cityCount",0)||0)}),{isEmpty:b,cities:a,clz:"droplist-shop",total:0==c?"":"("+c+")"}},n=function(){var a=l.find(".menu-city"),b=l.find(".menu-shop");IX.isEmpty(j)&&IX.isEmpty(k)?a.find("li:first-child").addClass("active"):!IX.isEmpty(j)&&IX.isEmpty(k)?(a.find("li[data-cityid="+j+"]").addClass("active"),b.find("ul[data-cityid="+j+"]").addClass("active").find("li:first-child").addClass("active")):(a.find("li[data-cityid="+j+"]").addClass("active"),b.find("ul[data-cityid="+j+"]").addClass("active").find("li[data-shopid="+k+"]").addClass("active"))};Hualala.ShopManager.getShopDataSetByGroupID(h,function(b){var c=m(b);l=a(e(c)),f.empty().append(l),n();var d=l.find(".menu-city"),h=l.find(".menu-shop");d.off("click").on("click",".city-item",function(){var b=a(this),c=b.attr("data-cityid");return d.find(".city-item.active").removeClass("active"),b.addClass("active"),h.find(">ul").removeClass("active"),IX.isEmpty(c)?(g.attr("data-shopid",""),g.attr("data-cityid",""),g.find(".label").html(b.find(".label").html()),i(g),!0):(h.find(">ul[data-cityid="+c+"]").addClass("active"),!1)}),h.off("click").on("click",".shop-item",function(){var b=a(this);return h.find(".shop-item").removeClass("active"),b.addClass("active"),g.attr("data-cityid",b.attr("data-cityid")),g.attr("data-shopid",b.attr("data-shopid")),g.find(".label").html(b.find(".label").html()),i(g),!0})})}};Hualala.UI.ShopDropList=f;var g=function(d){var e=b.compile(c.get("tpl_cycle_droplist")),f=$XP(d,"container"),g=$XP(d,"targetEl"),h=$XF(d,"selectFn");if(f&&g){var i=g.attr("data-value"),j=null,k=Hualala.TypeDef.CycleTypes,l=function(a){var b=a&&0!=a.length?!1:!0,c=_.map(a,function(a){var b=$XP(a,"value"),c=$XP(a,"label"),d=b==i?"active":"";return{value:b,active:d,label:c}});return{clz:"droplist-cycle",isEmpty:b,items:c}};j=a(e(l(k))),f.empty().append(j),j.off("click").on("click",".list-item",function(){var b=a(this);j.find(".list-item.active").removeClass("active"),b.addClass("active"),g.attr("data-value",b.attr("data-value")),g.find(".label").html(b.find(".label").html()),h(g)})}};Hualala.UI.CycleDropList=g;var h=function(d){var e=b.compile(c.get("tpl_indicator_droplist")),f=$XP(d,"container"),g=$XP(d,"targetEl"),h=$XF(d,"selectFn");if(f&&g){var i=g.attr("data-value"),j=null,k=_.filter(Hualala.TypeDef.BrandDetailRows,function(a){return"list"!==a.type}),l=function(a){var b=a&&0!=a.length?!1:!0,c=_.map(a,function(a){var b=$XP(a,"chartType"),c=$XP(a,"label"),d=b==i?"active":"";return{value:b,active:d,label:c}});return{clz:"droplist-cycle",isEmpty:b,items:c}};j=a(e(l(k))),f.empty().append(j),j.off("click").on("click",".list-item",function(){var b=a(this);j.find(".list-item.active").removeClass("active"),b.addClass("active"),g.attr("data-value",b.attr("data-value")),h(g)})}};Hualala.UI.ChartDropList=h}(jQuery,window),function(a,b){function c(a,b){f=a,b()}function d(a){var b=IX.getTimeInMS(),d=Hualala.PageRoute;log("BI Sys Init : "+b),Hualala.Global.loadAppData({},function(e){if(log("Load BI APP Data in (ms): "+(IX.getTimeInMS()-b)),0!=$XP(e,"resultcode"))throw d.jumpPage(d.createPath("login")),"Session Data Load Faild!! resultcode = "+$XP(e,"resultcode","")+"; resultMsg = "+$XP(e,"resultmsg","");c($XP(e,"data",{}),function(){log("Merchant Sys INIT DONE in (ms): "+(IX.getTimeInMS()-b)),a()})},function(){d.jumpPage(d.createPath("login"))})}function e(){IX.nsExisted("Hualala.ajaxEngine.init")&&(a.ajaxSetup({beforeSend:function(b){b.setRequestHeader("X-CSRF-Token",a('meta[name="csrf-token"]').attr("content"))}}),Hualala.ajaxEngine.init({ajaxFn:a.ajax,baseUrl:Hualala.Global.HOME,commonUrl:Hualala.Global.CommonSite,imgUrl:Hualala.Global.IMAGE_ROOT}))}IX.ns("Hualala");var f=null;Hualala.getSessionData=function(){return f},Hualala.isSessionUser=function(a,b){return _.find(f,function(c){return $XP(c,"groupLoginName")===a&&$XP(c,"loginName")===b})};var g=!1;Hualala.init=function(){g||(e(),Hualala.PageRoute.start(function(a,b,c){d(function(){Hualala.ShopManager||(Hualala.ShopManager=new Hualala.Model.ShopModel),c&&c.apply(null,[a,b])})}),g=!0)},b.addEventListener("push",function(){console.info("run push event callback")})}(jQuery,window),function(a){IX.ns("Hualala.Common");var b=Hualala.Common;b.IndexInit=function(){document.location.href=Hualala.PageRoute.createPath("main",["day"])},b.initPageLayout=function(){var b=(Hualala.getSessionData(),Handlebars.compile(Hualala.TplLib.get("tpl_site_layout"))),c=a(b());a("body > #ix_wrapper").remove(),c.appendTo("body")},b.LoginInit=function(b){Hualala.Common.initPageLayout({},b);var c=a("body > #ix_wrapper"),d=new Hualala.Entry.LoginInit({container:c});return d},b.SchemaPageInit=function(c){console.info("Schema Page "),b.initPageLayout({},c);var d=a("body > #ix_wrapper"),e=new Hualala.Brand.BrandListController({container:d,view:new Hualala.Brand.BrandListView,model:new Hualala.Model.BrandListModel});return e},b.BrandPageInit=function(c){b.initPageLayout({},c);var d=a("body > #ix_wrapper"),e=new Hualala.Brand.BrandDetailController({container:d,view:new Hualala.Brand.BrandDetailView,model:new Hualala.Model.BrandListModel});return e},b.BrandChartPageInit=function(c){b.initPageLayout({},c);var d=a("body > #ix_wrapper"),e=new Hualala.Brand.BrandChartController({container:d,view:new Hualala.Brand.BrandChartView,model:new Hualala.Model.BrandListModel});return e},b.AboutMePageInit=function(c){b.initPageLayout({},c);var d=a("body > #ix_wrapper");d.html(['<header class="bar bar-nav">','<a class="icon icon-person pull-right" href="/#login" data-transition="slide-in" data-href="push"></a>','<h1 class="title">老板通</h1>',"</header>",'<div class="content">','<h1 class="title">个人信息</h1>',"</div>"].join(""))}}(jQuery,window),function(a){IX.ns("Hualala.Entry");var b=Hualala.Global,c=Hualala.UI,d=Handlebars,e=Hualala.TplLib,f=[{name:"group_name",type:"text",placeholder:"",clz:"form-control input-row",key:"groupName",label:"集团主账号",field:{validators:{notEmpty:{message:"请输入主账号"}}}},{name:"group_subname",type:"text",placeholder:"",clz:"form-control input-row",key:"childName",label:"集团子账号",field:{validators:{notEmpty:{message:"请输入子账号"},stringLength:{min:3,max:50,message:"账号名称长度在3-50个字符之间"},loginName:{message:"账号名称只能包含数字、英文字母和下划线(_)"}}}},{name:"login_pwd",type:"password",placeholder:"",clz:"form-control input-row",key:"password",label:"登录密码",field:{validators:{notEmpty:{message:"请输入登录密码"},stringLength:{min:6,max:32,message:"密码长度必须在6位到32位之间"}}}},{name:"login_auth",type:"text",placeholder:"",clz:"form-control input-row",key:"authCode",label:"验证码",field:{validators:{notEmpty:{message:"请输入验证码"}}}},{name:"group_mobile",type:"text",placeholder:"",clz:"form-control input-row",key:"userMobile",label:"手机号",field:{validators:{notEmpty:{message:"请输入账号绑定的手机号"},mobile:{message:"请输入中国地区正确的手机号"}}}},{name:"mobile_pwd",type:"password",placeholder:"",clz:"form-control input-row",key:"dynamicPwd",label:"验证码",field:{validators:{notEmpty:{message:"请输入短信动态验证码"}}}}],g=new IX.IListManager;_.each(f,function(a){var b=$XP(a,"name");g.register(b,a)});var h="group_name,group_subname,login_pwd,login_auth".split(","),i="group_mobile,mobile_pwd".split(","),j=[{id:"login",label:"账号登录"},{id:"mbilogin",label:"手机号登录"}],k=function(f){var g=$XP(f,"container"),h=b.genAuthCode,i=d.compile(e.get("tpl_auth_code")),j=null,k=function(a){h({},function(b){var d=null;"000"==$XP(b,"resultcode")?d=$XP(b,"data.code",null):c.TopTip({type:"warning",msg:"获取验证码失败"}),a(d)})},l=function(a){return a?void j.attr("src",a):void setTimeout(function(){k(l)},1e3)},m=function(){g.find(".bi-authcode").remove(),g.append(i()),j=g.find(".auth-img"),k(l),n()},n=function(){g.find(".auth-img").unbind("click").on("click",function(b){j=a(b.target),k(l)})};return m(),{genCode:function(){k(l)}}},l=function(a){var f=$XP(a,"container"),g=$XF(a,"getParams"),h=$XP(a,"waiting",60),i=b.getMobileDynamicPWD,j=d.compile(e.get("tpl_dynamic_pwd")),k=null,l="获取验证码",m="发送中...",n=function(){f.find(".bi-dynamicpwd").remove(),f.append(j({label:l,loadingText:m})),k=f.find(".bi-dynamicpwd"),q()},o=function(a){var b=g();return b?void i(b,function(b){"000"===$XP(b,"resultcode")?(c.TopTip({type:"success",msg:$XP(b,"resultmsg","")||"短信发送成功"}),a()):(c.TopTip({type:"danger",msg:$XP(b,"resultmsg","")||"发送动态密码失败"}),k.text(l))}):(k.text(l),void k.removeClass("disabled"))},p=function(){var a=h;timmer=setInterval(function(){if(a--,0==a)return clearInterval(timmer),k.text(l),void k.removeClass("disabled");var b="{time}秒后重试",c=b.replaceAll("{time}",a);k.text(c)},1e3)},q=function(){k.unbind("click").on("click",function(a){a.preventDefault(),k.hasClass("disabled")||(k.addClass("disabled"),k.text(k.attr("data-loading-text")),o(p))})};n()};Hualala.Entry.LoginInit=Stapes.subclass({constructor:function(a){this.$container=$XP(a,"container"),this.mode=$XP(a,"mode","login"),this.callServer="login"==this.mode?b.loginCallServer:b.dynamicLoginCallServer,this.formKeys=[],this.formFieldHT=g,this.formFields=[],this.$subBtn=null,this.authCode=null,this.dinamicPWD=null,this.init()}}),Hualala.Entry.LoginInit.proto({init:function(){var a=this;a.renderLayout(),a.bindEvent()},mapFormElsData:function(a){var b=this,c="login"==a?h:i;return _.map(c,function(a){var c=b.formFieldHT.get(a);return IX.inherit(c,{id:$XP(c,"name","")})})},mapRenderData:function(){var a=this,b="<p>忘记账号密码，请联系您的系统管理员</p>",c=["<h5>长时间收不到验证码？</h5>","<p>","请检查手机号是否正确，如果正确但长时间没有收到验证码短信，可能是因为短信运营商网络不太给力，请拨打客服电话获取验证码&mdash;&mdash;",'<a href="tel:4006527557" class="bi-contact">4006527557</a>',"</p>"].join(""),d=_.map(j,function(b){var c=$XP(b,"id");return IX.inherit(b,{active:a.mode==c?"active":""})}),e=_.map(j,function(d){var e=$XP(d,"id");return IX.inherit(d,{clz:"bi-login",active:a.mode==e?"active":"",items:a.mapFormElsData(e),desc:"login"==e?b:c})});return{appBar:{title:"登录"},segHeads:d,segContents:e}},renderLayout:function(){var a=this,b=d.compile(e.get("tpl_site_login")),c=a.mapRenderData();d.registerPartial("appBar",e.get("tpl_app_bar")),d.registerPartial("iconBtn",e.get("tpl_icon_btn")),d.registerPartial("commonBtn",e.get("tpl_common_btn")),a.$container.html(b(c)),a.initAuthCode(),a.initDynamicPWD()},initAuthCode:function(){var a=this,b=a.$container.find("[name=login_auth]").parent();a.authCode=new k({container:b})},initDynamicPWD:function(){var a=this,b=a.$container.find("[name=group_mobile]").parent();a.dinamicPWD=new l({container:b,getParams:function(){var b=a.$container.find("#group_mobile"),d=a.getFormData(),e=b.parents(".sv-form"),f=e.data("smileyValidator"),g=(e.find("[name=group_mobile]"),{});return _.each(d,function(a,b){"userMobile"==b&&(g[b]=a)}),f.isValidField("group_mobile")?g:(c.TopTip({type:"danger",msg:"请检查手机号是否正确"}),null)}})},bindEvent:function(){var d=this;d.$container.on("click",".bi-login-tab .control-item",function(c){d.mode=a(c.target).attr("href").slice(1),d.callServer="login"==d.mode?b.loginCallServer:b.dynamicLoginCallServer}),d.$container.on("click",".subBtn",function(b){b.preventDefault();var c=a("#"+d.mode).find("form").data("smileyValidator");c.validate()}),_.each(j,function(b){var e=$XP(b,"id"),f=a("#"+e).find("form"),g=d.initValidFieldOpts(e);f.smileyValidator({fields:g,when:"blur",submitButton:".subBtn"}).on("error.field.sv",function(){}).on("success.field.sv",function(){}).on("error.form.sv",function(a,b){var d=$XP(b,"message","");c.TopTip({type:"danger",msg:d})}).on("success.form.sv",function(){var a=d.getFormData();d.callServer(a,function(a){"000"==$XP(a,"resultcode")?Hualala.PageRoute.jumpPage(Hualala.PageRoute.createPath("main",[""])):c.TopTip({type:"danger",msg:$XP(a,"resultmsg","")||"登录失败"})})})})},getFormData:function(){var b=this,c="login"==b.mode?h:i,d={};return _.each(c,function(c){var e=b.formFieldHT.get(c),f=$XP(e,"name"),g=$XP(e,"key"),h=a("[name="+f+"]",b.$container).val();d[g]=h}),IX.Debug.info("DEBUG:"+("login"==b.mode?"Login":"Mobile Login")+" Form Data: "),IX.Debug.info(d),d},initValidFieldOpts:function(a){var b=this,c="login"==(a||b.mode)?h:i,d={};return _.each(c,function(a){var c=b.formFieldHT.get(a),e=$XP(c,"field",{});d[a]=e}),d}})}(jQuery,window),function(){IX.ns("Hualala.Model");var a=Hualala.Global,b=Hualala.Model,c=Hualala.TypeDef,d=Hualala.Constants,e=function(){var a=Hualala.getSessionData(),b=_.map(a,function(a){return $XP(a,"groupID")});return b.join(",")},f=Stapes.subclass({constructor:function(){this.queryKeys="groupIDLst,shopIDLst,cityIDLst,pageNo,pageSize,cycleType,",this.callServer=a.getGroupStatistic}});f.proto({init:function(a){this.set({ds_curBiz:new IX.IListManager,ds_hisBiz:new IX.IListManager}),this.updateQueryParams(a)},updateQueryParams:function(a){var b=this;_.each(a,function(a,d){if(b.queryKeys.indexOf(d+",")>-1){var f=a;switch(d){case"cycleType":f=a||c.CycleTypes[0].value;break;case"groupIDLst":f=IX.isEmpty(f)?e():f;break;case"pageNo":f=a||0;break;case"pageSize":f=a||c.MaxBrandHistoryCount;break;default:f=a}b.set(d,f)}})},getQueryParams:function(){var a=this;return a.get.apply(a,a.queryKeys.slice(0,-1).split(","))},load:function(a,b){var c=this,d=c.getQueryParams();c.callServer(d,function(d){"000"==$XP(d,"resultcode")?(c.updateDataStore($XP(d,"data",null)),a.call(c,d)):(c.clear(),b.call(c,d))})},clear:function(){this.get("ds_curBiz").clear(),this.get("ds_hisBiz").clear()},updateDataStore:function(a){var b=this,c=b.get("ds_curBiz"),d=b.get("ds_hisBiz"),e=$XP(a,"currBizData",[]),f=$XP(a,"hisBizData",[]);this.clear(),_.each(e,function(a){var b=$XP(a,"groupID"),d=new g(a);c.register(b,d)}),_.each(f,function(a){var b=$XP(a,"groupID"),c=new g(a);d.get(b)||d.register(b,{groupID:b,data:[]}),d.get(b).data.push(c)})},getCurrentData:function(a){var b=this,c=IX.isEmpty(a)?null:IX.isArray(a)?a:a.split(","),d=b.get("ds_curBiz"),e=null;return e=null===c?d.getAll():d.getByKeys(c),_.map(e,function(a){return IX.inherit(a.getAll(),{_model:a})})},getHistoryData:function(a){var b=this,c=IX.isEmpty(a)?null:IX.isArray(a)?a:a.split(","),d=b.get("ds_hisBiz"),e=null;return e=null===c?d.getAll():d.getByKeys(c),_.map(e,function(a){var b=_.map(a.data,function(a){return IX.inherit(a.getAll(),{_model:a})});return IX.inherit(a,{data:b})})}}),b.BrandListModel=f;var g=Stapes.subclass({constructor:function(a){this.set(a)}});g.proto({getSchemaData:function(){var a=this,b="groupID,groupName,groupLogoImageUrl,personTotal,orderCountTotal,orderAomoutTotal",c=a.get.apply(a,b.split(","));return IX.inherit(c,{personUnit:d.PersonUnit,cashUnit:d.CashUnit,orderUnit:d.OrderUnit})},getDetailData:function(){var a=this,b="groupID,groupName,groupLogoImageUrl,personTotal,orderCountTotal,orderAomoutTotal,waitCheckoutOrderAmountTotal,paidAmountTotal,promotionAmountTotal,personAvg,orderAvg,unvipOrderAmountTotal,vipOrderAmountTotal,untakeawayOrderAmountTotal,takeawayOrderAmountTotal,paidAmountPayLst,reportDate",c=a.get.apply(a,b.split(","));return IX.inherit(c,{personUnit:d.PersonUnit,cashUnit:d.CashUnit,orderUnit:d.OrderUnit})}}),b.BrandModel=g;var h=Stapes.subclass({constructor:function(){this.groupHT=new IX.IListManager,this.citySet={},this.shopSet={},this.callServer=a.getShopQuerySchema,this.init()}});h.proto({init:function(){var a=this,b=Hualala.getSessionData();_.each(b,function(b){var c=$XP(b,"groupID");a.groupHT.register(c,b),a.citySet[c]=new IX.IListManager,a.shopSet[c]=new IX.IListManager})},load:function(a,b){var c=this,d=$XP(a,"groupID",null);d&&c.callServer(a,function(a){if("000"==a.resultcode){var e=$XP(a,"data.cities",[]),f=$XP(a,"data.shops",[]),g=c.citySet[d],h=c.shopSet[d];_.each(e,function(a){var b=$XP(a,"cityID"),c=_.filter(f,function(a){return $XP(a,"cityID")===b});g.register(b,IX.inherit(a,{items:_.map(c,function(a){return $XP(a,"shopID")})}))}),_.each(f,function(a){h.register($XP(a,"shopID"),a)}),b()}else Hualala.UI.TopTip({msg:$XP(a,"resultmsg","")||"数据请求失败",type:"danger"})})},getCitySet:function(a,b){var c=this,d=c.citySet[a];d.isEmpty()?c.load({groupID:a},function(){b.apply(c,[d.getAll()])}):b.apply(c,[d.getAll()])},getShopSet:function(a,b){var c=this,d=c.shopSet[a];d.isEmpty()?c.load({groupID:a},function(){b.apply(c,[d.getAll()])}):b.apply(c,[d.getAll()])},getShopDataSetByGroupID:function(a,b){var c=this,d=c.shopSet[a],e=c.citySet[a],f=null,g=null;e.isEmpty()?c.load({groupID:a},function(){f=e.getAll(),g=_.map(f,function(a){var b=($XP(a,"cityID"),$XP(a,"items",[]));return IX.inherit(a,{shops:d.getByKeys(b)})}),b.call(c,g)}):(f=e.getAll(),g=_.map(f,function(a){var b=($XP(a,"cityID"),$XP(a,"items",[]));return IX.inherit(a,{shops:d.getByKeys(b)})}),b.call(c,g))},getGroupSet:function(){return this.groupHT.getAll()}}),b.ShopModel=h}(jQuery,window),function(a){IX.ns("Hualala.Brand");var b=Hualala.Brand,c=Hualala.PageRoute,d=(Hualala.UI,Handlebars),e=Hualala.TplLib,f=Hualala.TypeDef.CycleTypes,g=Stapes.subclass({constructor:function(){this.container=null,this.model=null,this.loadTemplates(),this.curCycleType=f[0].value,this.$curCnt=null}});g.proto({init:function(a){this.container=$XP(a,"container",null),this.model=$XP(a,"model",null);var b=this.model.getQueryParams();if(!this.container||!this.model)throw"Brand list view init failed!!";this.curCycleType=$XP(b,"cycleType","day"),this.initLayout()},mapAppBarData:function(){return{clz:"",iconBtn:{items:[{clz:"icon-person pull-right",label:"个人信息",href:c.createPath("aboutme")}]},title:"老板通"}},mapSegmentsData:function(){var a=this,b=_.map(f,function(b){var c=b.value;return IX.inherit(b,{active:a.curCycleType==c?"active":"",clz:"",href:"#"+c,id:c})});return{clz:"",segments:b}},initLayout:function(){var a=this.get("layoutTpl"),b=this.get("segmentsTpl"),c=a({appBar:this.mapAppBarData()});this.container.html(c),c=b(this.mapSegmentsData()),this.container.find(".content").html(c),this.bindEvent()},loadTemplates:function(){var a=d.compile(e.get("tpl_page_layout")),b=d.compile(e.get("tpl_segment_bar")),c=d.compile(e.get("tpl_brand_list"));d.registerPartial("appBar",e.get("tpl_app_bar")),d.registerPartial("iconBtn",e.get("tpl_icon_btn")),d.registerPartial("commonBtn",e.get("tpl_common_btn")),this.set({layoutTpl:a,segmentsTpl:b,listTpl:c})},mapContentData:function(a){var b=this,d="",e=_.map(a,function(a){var d=$XP(a,"_model"),e=d.getSchemaData(),f=$XP(e,"groupLogoImageUrl","");return IX.inherit(e,{clz:"",href:c.createPath("brand",[b.curCycleType,$XP(e,"groupID"),"",""]),logo:IX.isEmpty(f)?Hualala.Global.getDefaultImage("blank"):Hualala.Common.getSourceImage(f,{width:40,height:40,quality:50})})});return{clz:d,items:e}},render:function(){var a=this,b=a.get("listTpl"),c=a.mapContentData(a.model.getCurrentData()),d=b(c);a.$curCnt=a.container.find("#"+a.curCycleType),a.$curCnt.empty().html(d)},bindEvent:function(){var b=this;b.container.on("click",".segmented-control .control-item",function(){var c=a(this),d=c.attr("href").slice(1);
b.curCycleType=d,b.emit("switchCycle")})}}),b.BrandListView=g}(jQuery,window),function(){IX.ns("Hualala.Brand");var a=Hualala.Brand,b=Hualala.PageRoute,c=Stapes.subclass({constructor:function(a){if(this.container=$XP(a,"container",null),this.view=$XP(a,"view",null),this.model=$XP(a,"model",null),!this.container||!this.view||!this.model)throw"BrandList Controller build failed!";this.bindEvent(),this.bindViewEvent(),this.bindModelEvent();var c=b.getPageContextByPath(),d=$XP(c,"params",[]);this.emit("load",{cycleType:d[0]||"day",groupIDLst:"",shopIDLst:"",pageNo:"0"})}});c.proto({init:function(a){this.model.init(a),this.view.init({model:this.model,container:this.container})},bindEvent:function(){this.on({load:function(a){var b=this;b.init(a),b.model.load(function(){b.view.emit("render")},function(){})}},this)},bindViewEvent:function(){this.view.on({render:function(){var a=this;a.view.render()},switchCycle:function(){var a=this,b=a.model.getQueryParams();a.model.updateQueryParams(IX.inherit(b,{cycleType:a.view.curCycleType})),a.model.load(function(){a.view.emit("render")},function(){})}},this)},bindModelEvent:function(){}}),a.BrandListController=c}(jQuery,window),function(a){IX.ns("Hualala.Brand");var b=Hualala.Brand,c=Hualala.PageRoute,d=Hualala.TypeDef,e=Hualala.UI,f=Hualala.Constants,g=Hualala.Common,h=Handlebars,i=Hualala.TplLib,j=d.CycleTypes,k=Stapes.subclass({constructor:function(){this.container=null,this.model=null,this.loadTemplates(),this.curCycleType=null,this.curGroupIDLst=null,this.curShopIDLst=null,this.curCityIDLst=null,this.curDateList=null,this.$curCnt=null}});k.proto({init:function(a){this.container=$XP(a,"container",null),this.model=$XP(a,"model",null);var b=this.model.getQueryParams(),d=c.getPageContextByPath();if(!this.container||!this.model)throw"Brand Detail view init failed!!";this.curCycleType=d.params[0]||$XP(b,"cycleType","day"),this.curGroupIDLst=d.params[1]||$XP(b,"groupIDLst",""),this.curCityIDLst=d.params[2]||"",this.curShopIDLst=d.params[3]||$XP(b,"shopIDLst",""),this.initLayout()},loadTemplates:function(){var a=h.compile(i.get("tpl_page_layout")),b=h.compile(i.get("tpl_filter_toolbar")),c=h.compile(i.get("tpl_statistic_table"));h.registerPartial("appBar",i.get("tpl_app_bar")),h.registerPartial("iconBtn",i.get("tpl_icon_btn")),h.registerPartial("commonBtn",i.get("tpl_common_btn")),h.registerPartial("commonCol",i.get("tpl_tblcell_common")),h.registerPartial("chartCol",i.get("tpl_tblcell_chart")),h.registerPartial("listCol",i.get("tpl_tblcell_list")),h.registerHelper("chkRowType",function(a,b){return a==b.hash.type?b.fn(this):b.inverse(this)}),this.set({layoutTpl:a,filterBarTpl:b,cntTpl:c})},mapAppBarData:function(){var a=this,b=c.getParentNamesByPath();return{clz:"",iconBtn:{items:[{clz:"icon-person pull-right",label:"个人信息",href:c.createPath("aboutme")},{clz:"icon-left-nav pull-left",label:"返回",href:c.createPath($XP(b[0],"name","main"),[a.curCycleType])}]},title:"老板通"}},mapFilterBarData:function(a){var b=this,c=d.FilterFields,e=_.map(c,function(c){var d=$XP(c,"key"),e=($XP(c,"clz"),""),f="",g=!1,h="";switch(d){case"groupIDLst":f=b.curGroupIDLst||"",e='<img src="'+b.getGroupLogoUrl(f)+'" alt="brand-logo" class="brand-logo" />';break;case"shopIDLst":h=b.curCityIDLst||"",f=b.curShopIDLst||"",IX.isEmpty(h)&&IX.isEmpty(f)?e="全部店铺":!IX.isEmpty(h)&&IX.isEmpty(f)?(e="全部店铺",_.each(a,function(a){var b=$XP(a,"cityID"),c=$XP(a,"cityName");b==h&&(e=c+e)})):(e="",_.each(a,function(a){var b=$XP(a,"cityID"),c=($XP(a,"cityName"),$XP(a,"shops",[]));_.each(c,function(a){var c=$XP(a,"shopID"),d=$XP(a,"shopName");c==f&&(e=d,h=b)})})),g=!0;break;case"cycleType":f=b.curCycleType||"day",e=$XP(b.getCycleTypeData(b.curCycleType),"label")}return IX.inherit(c,{value:f,label:e,cityID:h,isShopFilter:g})});return{items:e}},getCycleTypeData:function(a){var b=j;return _.find(b,function(b){return $XP(b,"value")===a})},getGroupLogoUrl:function(a){var b=Hualala.getSessionData(),c=_.find(b,function(b){return $XP(b,"groupID")===a}),d=$XP(c,"groupLogoImageUrl","");return d=IX.isEmpty(d)?Hualala.Global.getDefaultImage("blank"):Hualala.Common.getSourceImage(groupLogoImageUrl,{width:40,height:40,quality:50})},initLayout:function(){var a=this,b=this.get("layoutTpl"),c=this.get("filterBarTpl"),d=b({appBar:this.mapAppBarData()});this.container.html(d),Hualala.ShopManager.getShopDataSetByGroupID(this.curGroupIDLst,function(b){var d=c(a.mapFilterBarData(b));a.container.find(".content").html(d),a.bindToolbarEvent(),a.bindCntEvent()})},bindCntEvent:function(){var b=this;b.container.on("click",".bi-table > .table-header > .hisdate > .icon",function(c){var d=a(this),e=d.parent().find(".date"),f=b.curDateList.slice(1),g="",h=d.hasClass("icon-left")?-1:1;c.preventDefault();{var i=b.container.find(".bi-table > .table-body > a.table-row:first-child"),j=b.container.find(".bi-table > .table-body > a.table-row"),k=i.find(".table-cell.hisdate"),l=-1;k.filter(function(b,c){var d=!a(c).hasClass("hidden");return 1==d&&(l=b),d})}l+=h,0>l?l=0:l>=k.length-1&&(l=k.length-1),j.each(function(b,c){var d=a(c),e=d.find(".table-cell.hisdate");e.addClass("hidden"),e.eq(l).removeClass("hidden")}),g=f[l]+"("+l+")",e.html(g)})},setNavBtnHref:function(){var b=this,d=c.getParentNamesByPath(),e=$XP(c.getPageContextByPath(),"name"),f=-1;_.find(d,function(a,b){var c=a.name==e;return c&&(f=b),c}),f-=1;var g=0>f?"main":$XP(d[f],"name",""),h="main"==g?[b.curCycleType]:[b.curCycleType,b.curGroupIDLst,b.curCityIDLst,b.curShopIDLst],i=c.createPath(g,h);a("header.bi-bar").find(".icon-left-nav").attr("href",i)},resetShopFilter:function(){var a=this,b=a.container.find('.filter-item[data-key="shopIDLst"]');b.attr("data-shopid",a.curShopIDLst).attr("data-cityid",a.curCityIDLst).find(".filter-shop").html("全部店铺")},bindToolbarEvent:function(){var b=this;b.container.find(".filter-item").dropdown({parentSelector:".bi-toolbar"}),b.container.find(".bi-toolbar").on("show.ra.dropdown",function(c){var d=a(c.relatedTarget),f=d.attr("data-key"),g=(d.attr("data-value")||"",a(this)),h=null;switch(f){case"groupIDLst":h=new e.GroupDropList({container:g.find(".dropdown-menu"),targetEl:d,selectFn:function(a){b.curGroupIDLst=a.attr("data-value"),b.emit("switchBrand"),b.setNavBtnHref()}});break;case"shopIDLst":h=new e.ShopDropList({container:g.find(".dropdown-menu"),groupID:b.curGroupIDLst,targetEl:d,selectFn:function(a){b.emit("switchShop",{cityID:a.attr("data-cityid"),shopID:a.attr("data-shopid")}),b.setNavBtnHref()}});break;case"cycleType":h=new e.CycleDropList({container:g.find(".dropdown-menu"),targetEl:d,selectFn:function(a){b.curCycleType=a.attr("data-value")||"day",b.emit("switchCycle"),b.setNavBtnHref()}})}})},mapDateList:function(a){var b=this,c=b.curCycleType;return _.map(a,function(a){var b=$XP(a,"reportDate","");switch(c){case"day":b=b.split("-"),b=_.map(b,function(a){var b=g.formatDateTimeValue(a),c=f.NameOfDay[new Date(b).getDay()];return IX.Date.getDateByFormat(b,"MM.dd")+"("+c+")"}),b=b[0];break;case"week":b=b.split("-"),b=_.map(b,function(a){var b=g.formatDateTimeValue(a);return IX.Date.getDateByFormat(b,"MM.dd")}),b=b.join("-");break;case"month":b=b.split("-"),b=_.map(b,function(a){var b=g.formatDateTimeValue(a);return IX.Date.getDateByFormat(b,"YYYY.MM")}),b=b[0];break;case"quarter":b=b.split("-"),b=_.map(b,function(a){var b=g.formatDateTimeValue(a);return IX.Date.getDateByFormat(b,"YYYY.MM")}),b=b.join("-")}return b})},mapHeaderData:function(a){var b=this,c=(b.curCycleType,[]),d=$XP(a,"curData",[]),e=$XP(a,"hisData",[]);e=_.find(e,function(a){return b.curGroupIDLst==$XP(a,"groupID")}),e=$XP(e,"data",[]),d=_.map(d,function(a){var b=$XP(a,"_model");return b.getDetailData()}),e=_.map(e,function(a){var b=$XP(a,"_model");return b.getDetailData()}),c=b.mapDateList(d.concat(e)),b.curDateList=c;var f=_.map(c.slice(0,2),function(a,b){var c=0==b?!1:!0;return IX.inherit({dateStr:a,clz:c?"hisdate":"curdate",isHistory:c},c?{iconBtn:{items:[{clz:"icon-left pull-left",href:"",label:"向前"},{clz:"icon-right pull-right",href:"",label:"先后"}]}}:{})});return f},mapCommonColData:function(a,b){var c=$XP(a,"label",""),d=($XP(a,"type",""),$XP(a,"keys","")),e=($XP(a,"chartType",""),$XP(a,"unCheckoutLabel",null)),f=IX.isEmpty(e)?!1:!0,g=_.map(b,function(a,b){var g=0==b?!0:!1,h=b>1?"hidden":"",i=IX.inherit({clz:g?"curdate":"hisdate",label:c,hasUncheckout:f,hidden:h},f?{unCheckoutLabel:e}:{});return _.each(d.split(","),function(b){var c=$XP(a,b);switch(b){case"groupID":case"waitCheckoutOrderAmountTotal":i[b]=c;break;case"personUnit":case"orderUnit":case"cashUnit":i.unit=c;break;default:i.value=c}}),i});return g},mapChartColData:function(a,b){var c=$XP(a,"label",""),d=($XP(a,"type",""),$XP(a,"keys","").split(",")),e=($XP(a,"chartType",""),$XP(a,"legends")),f=$XP(a,"items","").split(","),g=_.map(b,function(a,b){var g=0==b?!0:!1,h=b>1?"hidden":"",i={clz:g?"curdate":"hisdate",label:c,hidden:h,items:_.map(f,function(b,c){var f={clz:"legend",iconClz:0==c?"mainIcon":"subIcon"},g=_.find(e,function(a){return a.key===b});return f.label=$XP(g,"label",""),_.each(d.concat([b]),function(b){var c=$XP(a,b);switch(b){case"cashUnit":f.unit=c;break;case"groupID":f[b]=c;break;default:f.value=c}}),f})};return i});return g},mapListColData:function(a,b){var c=$XP(a,"label",""),d=($XP(a,"type",""),$XP(a,"keys","")),e=($XP(a,"chartType",""),_.map(b,function(a,b){var e=0==b?!0:!1,f=b>1?"hidden":"",g={clz:e?"curdate":"hisdate",label:c,hidden:f};return _.each(d.split(","),function(b){var c=$XP(a,b);switch(b){case"groupID":case"cashUnit":g[b]=c;break;case"paidAmountPayLst":g.items=c}}),g}));return e},mapRowData:function(a){var b=this,c=(b.curCycleType,d.BrandDetailRows),e=(b.curDateList,$XP(a,"curData",[])),f=$XP(a,"hisData",[]);f=_.find(f,function(a){return b.curGroupIDLst==$XP(a,"groupID")}),f=$XP(f,"data",[]),e=_.map(e,function(a){var b=$XP(a,"_model");return b.getDetailData()}),f=_.map(f,function(a){var b=$XP(a,"_model");return b.getDetailData()});var g=e.concat(f),h=_.map(c,function(a){var c=$XP(a,"type"),d=$XP(a,"chartType",""),e=null;switch(c){case"common":e=b.mapCommonColData(a,g);break;case"chart":e=b.mapChartColData(a,g);break;case"list":e=b.mapListColData(a,g)}return{chartType:d,clz:c,href:b.getChartPagePath(d),type:c,cols:e}});return h},mapContentData:function(a){var b=this,c=b.mapHeaderData(a),d=b.mapRowData(a);return{header:c,rows:d}},render:function(){var b=this,c=b.get("cntTpl"),d=b.mapContentData({curData:b.model.getCurrentData(b.curGroupIDLst),hisData:b.model.getHistoryData(b.curGroupIDLst)}),e=c(d);b.$curCnt&&b.$curCnt.remove(),b.$curCnt=a(e).appendTo(b.container.find(".content"))},getChartPagePath:function(a){var b=this;return c.createPath("chart",[b.curCycleType,b.curGroupIDLst,b.curCityIDLst,b.curShopIDLst,a,""])}}),b.BrandDetailView=k}(jQuery,window),function(a){IX.ns("Hualala.Brand");var b=Hualala.Brand,c=Hualala.PageRoute,d=Hualala.TypeDef,e=Hualala.UI,f=(Hualala.Constants,Hualala.Common,Handlebars),g=Hualala.TplLib,h=(d.CycleTypes,b.BrandDetailView.subclass({constructor:b.BrandDetailView.prototype.constructor}));h.proto({init:function(a){this.container=$XP(a,"container",null),this.model=$XP(a,"model",null);var b=this.model.getQueryParams(),d=c.getPageContextByPath();if(!this.container||!this.model)throw"Brand Detail view init failed!!";this.curCycleType=d.params[0]||$XP(b,"cycleType","day"),this.curGroupIDLst=d.params[1]||$XP(b,"groupIDLst",""),this.curCityIDLst=d.params[2]||"",this.curShopIDLst=d.params[3]||$XP(b,"shopIDLst",""),this.curIndicatorID=d.params[4],this.chartIndicatorList=_.filter(Hualala.TypeDef.BrandDetailRows,function(a){return"list"!=a.type}),this.initLayout()},loadTemplates:function(){var a=f.compile(g.get("tpl_page_layout")),b=f.compile(g.get("tpl_filter_toolbar")),c=f.compile(g.get("tpl_brand_chart"));f.registerPartial("appBar",g.get("tpl_app_bar")),f.registerPartial("iconBtn",g.get("tpl_icon_btn")),f.registerPartial("commonBtn",g.get("tpl_common_btn")),this.set({layoutTpl:a,filterBarTpl:b,cntTpl:c})},getCurIndicatorCfg:function(a){var b=this,c=_.find(b.chartIndicatorList,function(b){return b.chartType==a});return c},mapAppBarData:function(){var a=this,b=c.getParentNamesByPath(),d=a.curIndicatorID,e=$XP(a.getCurIndicatorCfg(d),"label","");return{clz:"",commonBtn:{items:[{clz:"btn-link pull-right chart-droplist",label:"其他数据"}]},iconBtn:{items:[{clz:"icon-left-nav pull-left",label:"返回",href:c.createPath($XP(b[b.length-2],"name","main"),[a.curCycleType,a.curGroupIDLst,a.curCityIDLst,a.curShopIDLst])}]},title:e+"分析图表"}},bindCntEvent:function(){var b=this,c=a("header.bi-bar");c.find(".chart-droplist").attr("data-toggle","dropdown").attr("data-value",b.curIndicatorID).dropdown({parentSelector:".bi-bar"}),c.on("show.ra.dropdown",function(c){{var d=a(c.relatedTarget),f=a(this);new e.ChartDropList({container:f.find(".dropdown-menu"),targetEl:d,selectFn:function(a){b.curIndicatorID=a.attr("data-value");var c=$XP(b.getCurIndicatorCfg(b.curIndicatorID),"label","");b.emit("switchIndicator"),a.parents("header.bi-bar").find(".title").html(c+"分析图表")}})}})},genChartDataByPage:function(a,b){var c=this,d=c.curChartPageSize,e=$XP(a,"curData",[]),f=$XP(a,"hisData",[]);f=_.find(f,function(a){return c.curGroupIDLst==$XP(a,"groupID")}),f=$XP(f,"data",[]);for(var g=e.concat(f),h=c.mapDateList(g),i=_.find(c.chartIndicatorList,function(a){return $XP(a,"chartType")==b}),j=$XP(i,"items").split(","),k=($XP(i,"type"),h.length),l=Math.ceil(k/d),m=[],n=[],o=0;l>o;o++){var p=o*d,q=(o+1)*d,r=g.slice(p,q),s=[];switch(m.push(h.slice(p,q)),b){case"personTotal":case"orderCountTotal":case"orderAomoutTotal":case"paidAmountTotal":case"promotionAmountTotal":case"personAvg":case"orderAvg":s=_.map(j,function(a){return{fillColor:"rgba(20, 185, 214, 1)",strokeColor:"rgba(20, 185, 214, 1)",pointColor:"rgba(255, 255, 255, 1)",pointStrokeColor:"rgba(255, 255, 255, 1)",data:_.map(r,function(b){return $XP(b,a,0)})}});break;case"customStructure":s=_.map(j,function(a){var b="vipOrderAmountTotal"==a?"rgba(31, 187, 166, .5)":"rgba(204, 204, 204, .5)",c="vipOrderAmountTotal"==a?"会员":"非会员";return{label:c,fillColor:b,strokeColor:b,pointColor:b,pointStrokeColor:"rgba(255, 255, 255, 1)",pointHighlightFill:"rgba(255, 255, 255, 1)",pointHighlightStroke:b,data:_.map(r,function(b){return $XP(b,a,0)})}});break;case"orderStructure":s=_.map(j,function(a){var b="untakeawayOrderAmountTotal"==a?"rgba(31, 187, 166, .8)":"rgba(204, 204, 204, .8)",c="untakeawayOrderAmountTotal"==a?"堂食":"外卖";return{label:c,fillColor:b,strokeColor:b,pointColor:b,pointStrokeColor:"rgba(255, 255, 255, 1)",pointHighlightFill:"rgba(255, 255, 255, 1)",pointHighlightStroke:b,data:_.map(r,function(b){return $XP(b,a,0)})}})}n.push(s)}return{labelList:m,seriesList:n}},mapChartDataByIndicatorID:function(a,b){var c=this,d=$XP(a,"curData",[]),e=$XP(a,"hisData",[]);e=_.find(e,function(a){return c.curGroupIDLst==$XP(a,"groupID")}),e=$XP(e,"data",[]);{var f=d.concat(e),g=[],h=_.find(c.chartIndicatorList,function(a){return $XP(a,"chartType")==b}),i=$XP(h,"items").split(",");$XP(h,"type")}switch(b){case"personTotal":case"orderCountTotal":case"orderAomoutTotal":case"paidAmountTotal":case"promotionAmountTotal":case"personAvg":case"orderAvg":g=_.map(i,function(a){return{fillColor:"rgba(20, 185, 214, 1)",strokeColor:"rgba(20, 185, 214, 1)",pointColor:"rgba(255, 255, 255, 1)",pointStrokeColor:"rgba(255, 255, 255, 1)",data:_.map(f,function(b){return $XP(b,a,0)})}});break;case"customStructure":g=_.map(i,function(a){var b="vipOrderAmountTotal"==a?"rgba(31, 187, 166, .5)":"rgba(204, 204, 204, .5)",c="vipOrderAmountTotal"==a?"会员":"非会员";return{label:c,fillColor:b,strokeColor:b,pointColor:b,pointStrokeColor:"rgba(255, 255, 255, 1)",pointHighlightFill:"rgba(255, 255, 255, 1)",pointHighlightStroke:b,data:_.map(f,function(b){return $XP(b,a,0)})}});break;case"orderStructure":g=_.map(i,function(a){var b="untakeawayOrderAmountTotal"==a?"rgba(31, 187, 166, .8)":"rgba(204, 204, 204, .8)",c="untakeawayOrderAmountTotal"==a?"堂食":"外卖";return{label:c,fillColor:b,strokeColor:b,pointColor:b,pointStrokeColor:"rgba(255, 255, 255, 1)",pointHighlightFill:"rgba(255, 255, 255, 1)",pointHighlightStroke:b,data:_.map(f,function(b){return $XP(b,a,0)})}})}return{labels:_.map(c.mapDateList(d.concat(e)),function(a){return a}),datasets:g}},mapContentData:function(a){var b=this;return b.curChartPage=0,b.curChartPageSize=7,b.curChartData=b.genChartDataByPage(a,b.curIndicatorID),{clz:"chart"}},getScaleCfg:function(){var a=this,b=a.curChartData,c=($XP(b,"labels",[]),$XP(b,"datasets",[])),d=[];_.each(c,function(a){d=d.concat(a.data)});{var e=_.max(d,function(a){return parseFloat(a)}),f=_.max(d,function(a){return parseFloat(a)}),g=e-f;parseInt(g/10)}return{responsive:!0,scaleOverlay:!0,scaleFontFamily:"'Microsoft Yahei'",scaleFontSize:12,scaleFontColor:"rgb(145,165,183)",scaleShowGridLines:!0,scaleGridLinesColor:"rgba(103,112,124, 1)",pointDotRadius:5,onAnimationComplete:function(){console.info(arguments)},tooltipTitleFontStyle:"bold",multiTooltipTemplate:"<%if (datasetLabel){%><%=datasetLabel%>: <%}%><%= value %>",legendTemplate:'<ul class="<%=name.toLowerCase()%>-legend"><% for (var i=0; i<datasets.length; i++){%><li><span style="background-color:<%=datasets[i].lineColor%>"></span><%if(datasets[i].label){%><%=datasets[i].label%><%}%></li><%}%></ul>'}},drawChart:function(){var b=this,c=b.$curCnt.find(".chart-list"),d=b.curChartData,e=$XP(d,"labelList",[]),f=$XP(d,"seriesList",[]),g=b.$curCnt.width(),h=.8*b.$curCnt.height(),i=e.length;_.each(e,function(b,d){var e=f[d],i=a('<canvas class="chart-canvas pull-left"></canvas>');i.attr("width",g),i.attr("height",h),i.css({width:g+"px",height:h+"px",left:100*d+"%"}),i.appendTo(c);var j=i[0].getContext("2d"),k=new Chart(j).Line({labels:_.map(b,function(a){return a+"("+d+")"}),datasets:e},{responsive:!0,scaleOverlay:!0,scaleFontFamily:"'Microsoft Yahei'",scaleFontSize:12,scaleFontColor:"rgb(145,165,183)",scaleShowGridLines:!0,scaleGridLinesColor:"rgba(103,112,124, 1)",pointDotRadius:5,onAnimationComplete:function(){console.info(arguments)},tooltipTitleFontStyle:"bold",multiTooltipTemplate:"<%if (datasetLabel){%><%=datasetLabel%>: <%}%><%= value %>",legendTemplate:'<ul class="<%=name.toLowerCase()%>-legend"><% for (var i=0; i<datasets.length; i++){%><li><span style="background-color:<%=datasets[i].lineColor%>"></span><%if(datasets[i].label){%><%=datasets[i].label%><%}%></li><%}%></ul>'});i.data("data.chart",k)}),c.css({width:i*g+"px",height:h+"px"});var j=0,k=0,l=!1,m=c.find(".chart-canvas");c.find(".chart-canvas").unbind("touchy-drag").bind("touchy-drag",function(a,d,e,f){if(!l){var g=b.$curCnt.width(),h=f.movePoint.x-f.lastMovePoint.x,i=k+h/g;"move"===d?0>i&&i>1-m.length&&(k=i,c.css({WebkitTransition:"none",WebkitTransform:"translate3d("+100*k+"%, 0, 0"})):"end"===d&&k!==j&&(f.velocity>1.7?(k=k>j?j+1:j-1,n()):(k=Math.round(k),n()))}});var n=function(){l=!0,setTimeout(function(){l=!1},400),c.css({WebkitTransition:"-webkit-transform 0.4s cubic-bezier(1.0, 0.0, 1.0, 1.0)",WebkitTransform:"translate3d("+100*k+"%,0,0)"}),j=k}}}),b.BrandChartView=h}(jQuery,window),function(){IX.ns("Hualala.Brand");var a=Hualala.Brand,b=Hualala.PageRoute,c=a.BrandListController.subclass({constructor:function(a){if(this.container=$XP(a,"container",null),this.view=$XP(a,"view",null),this.model=$XP(a,"model",null),!this.container||!this.view||!this.model)throw"Brand Detail Controller build failed!";var c=b.getPageContextByPath(),d=$XP(c,"params",[]);this.bindEvent(),this.bindViewEvent(),this.bindModelEvent(),this.emit("load",{cycleType:d[0]||"day",groupIDLst:d[1]||"",shopIDLst:"",pageNo:1})}});c.proto({bindViewEvent:function(){this.view.on({render:function(){var a=this;a.view.render()},switchCycle:function(){var a=this,b=a.model.getQueryParams();a.model.updateQueryParams(IX.inherit(b,{cycleType:a.view.curCycleType})),a.model.load(function(){a.view.emit("render")},function(){})},switchBrand:function(){var a=this,b=a.model.getQueryParams();a.model.updateQueryParams(IX.inherit(b,{groupIDLst:a.view.curGroupIDLst,shopIDLst:"",cityIDLst:""})),a.view.curShopIDLst="",a.view.curCityIDLst="",a.view.resetShopFilter(),a.model.load(function(){a.view.emit("render")},function(){})},switchShop:function(a){var b=this,c=b.model.getQueryParams(),d=$XP(a,"cityID"),e=$XP(a,"shopID");IX.isEmpty(e)&&IX.isEmpty(d)?(b.model.updateQueryParams(IX.inherit(c,{shopIDLst:"",cityIDLst:""})),b.view.curCityIDLst="",b.view.curShopIDLst=""):IX.isEmpty(e)&&!IX.isEmpty(d)?Hualala.ShopManager.getCitySet($XP(c,"groupIDLst"),function(a){var e=_.find(a,function(a){return a.cityID===d}),f=$XP(e,"items",[]).join(",");b.model.updateQueryParams(IX.inherit(c,{shopIDLst:f,cityIDLst:d})),b.view.curCityIDLst=d,b.view.curShopIDLst=""}):(b.model.updateQueryParams(IX.inherit(c,{shopIDLst:e,cityIDLst:d})),b.view.curCityIDLst=d,b.view.curShopIDLst=e),b.model.load(function(){b.view.emit("render")},function(){})},resetShopFilter:function(){}},this)},bindModelEvent:function(){}}),a.BrandDetailController=c;var d=a.BrandDetailController.subclass({constructor:a.BrandDetailController.prototype.constructor});d.proto({bindViewEvent:function(){this.view.on({render:function(){var a=this;a.view.render(),a.view.drawChart(),a.view.setNavBtnHref()},switchCycle:function(){var a=this,b=a.model.getQueryParams();a.model.updateQueryParams(IX.inherit(b,{cycleType:a.view.curCycleType})),a.model.load(function(){a.view.emit("render")},function(){})},switchBrand:function(){var a=this,b=a.model.getQueryParams();a.model.updateQueryParams(IX.inherit(b,{groupIDLst:a.view.curGroupIDLst,shopIDLst:"",cityIDLst:""})),a.view.curShopIDLst="",a.view.curCityIDLst="",a.view.resetShopFilter(),a.model.load(function(){a.view.emit("render")},function(){})},switchShop:function(a){var b=this,c=b.model.getQueryParams(),d=$XP(a,"cityID"),e=$XP(a,"shopID");IX.isEmpty(e)&&IX.isEmpty(d)?(b.model.updateQueryParams(IX.inherit(c,{shopIDLst:""})),b.view.curCityIDLst="",b.view.curShopIDLst=""):IX.isEmpty(e)&&!IX.isEmpty(d)?Hualala.ShopManager.getCitySet($XP(c,"groupIDLst"),function(a){var e=_.find(a,function(a){return a.cityID===d}),f=$XP(e,"items",[]).join(",");b.model.updateQueryParams(IX.inherit(c,{shopIDLst:f,cityIDLst:d})),b.view.curCityIDLst=d,b.view.curShopIDLst=""}):(b.model.updateQueryParams(IX.inherit(c,{shopIDLst:e,cityIDLst:d})),b.view.curCityIDLst=d,b.view.curShopIDLst=e),b.model.load(function(){b.view.emit("render")},function(){})},switchIndicator:function(){var a=this;a.view.emit("render")}},this)}}),a.BrandChartController=d}(jQuery,window);